# Gemini CLI Speech Wrapper (PoC)

Gemini CLIの応答をリアルタイムで読み上げ、長文の場合は自動的に要約を生成して読み上げるラッパースクリプトです。ハイブリッド監視方式（ターミナル出力監視 + JSONセッション解析）により、正確なタイミングでの発話を実現しています。

## 特徴

- ✅ **インテリジェント読み上げ**: 50文字以上の応答を自動要約（カテゴリ付き）
- ✅ **リアルタイム検知**: ステートマシンにより、AIの書き出しと同時に反応
- ✅ **自動スキップ**: 実行許可（ツール実行）が必要な場合は、説明文をスキップして確認を優先
- ✅ **サマリーログ**: 要約を `~/.gemini/hooks/stop-hook-summary.log` に保存
- ✅ **デバッグモード**: 内部状態の変化を `~/.gemini/hooks/gemini-speak-debug.log` に出力

## スクリプトの仕様

本スクリプトは、内部的にステートマシン（状態管理）を維持し、ターミナル出力の特定のパターンをトリガーとして動作します。

### 1. 状態検知トリガー
- **応答開始 (`✦`)**: Geminiが回答の書き出しを開始したことを検知し、内部フラグを「応答中」に設定。
- **実行許可要求 (`Allow execution of:` または `│ ?`)**: ツール（コマンド実行やファイル操作）の承認が必要な状態を検知。
- **入力待ち (`│ >` または `Type your message`)**: Geminiの回答が完了し、ユーザーの入力を待っている状態を検知。

### 2. 読み上げ制御ロジック
- **コマンド実行の承認時**:
  - `✦` の後に実行許可要求が続いた場合、**説明文（content）の読み上げを自動的にスキップ**します。
  - 代わりに、「Bashコマンドを実行して良いですか？」などの簡潔な固定メッセージのみを即座に読み上げます。
  - 既に説明文の読み上げが開始されている場合は、それを中断（kill）して実行許可の確認を優先します。
- **通常応答時**:
  - 実行許可を伴わない純粋な回答の場合、入力待ち（プロンプト表示）を検知したタイミングで読み上げを開始します。
  - **50文字以内**: 原文をそのまま読み上げ。
  - **50文字超**: `gemini-2.0-flash` モデルを使用して高速に要約を生成し、【カテゴリ】付きのサマリーを読み上げ。

### 3. ロギング機能
- **サマリーログ**: 生成された要約は `~/.gemini/hooks/stop-hook-summary.log` に保存。実行時のカレントディレクトリも併記されます。
- **デバッグログ**: 内部的な状態遷移や検知ログは `~/.gemini/hooks/gemini-speak-debug.log` に出力。

## 必要条件

- **OS**: macOS (`say`コマンドに依存)
- **依存ツール**:
  - [Gemini CLI](https://github.com/google/gemini-cli) (インストールパス: `/opt/homebrew/bin/gemini`)
  - `jq`: セッションJSONのパースに使用

## 使い方

1. スクリプトに実行権限を与えます。
   ```bash
   chmod +x gemini-speak.sh
   ```

2. スクリプトを実行してGeminiとの対話を開始します。
   ```bash
   ./gemini-speak.sh
   ```

## エイリアスの設定

便利に呼び出すために、`~/.zshrc` にエイリアスを設定することをお勧めします。

1. スクリプトを適切なディレクトリに配置します（例：`~/.gemini/speak/`）。
   ```bash
   mkdir -p ~/.gemini/speak
   cp gemini-speak.sh ~/.gemini/speak/
   ```

2. `~/.zshrc` に以下の行を追加します。
   ```bash
   alias gemini-s='~/.gemini/speak/gemini-speak.sh'
   ```

3. 設定を反映させます。
   ```bash
   source ~/.zshrc
   ```

## 設定のカスタマイズ

スクリプト内の以下の箇所を調整することで、動作をカスタマイズ可能です。

- **要約用モデル**: `SUMMARY_MODEL="gemini-2.0-flash"` (速度重視の設定)
- **要約の閾値**: `if [ ${#content} -gt 50 ];` の数値を変更。
- **読み上げ速度**: `say -r 262` の数値を変更（219は約1.25倍速、262は約1.5倍速）。
- **カテゴリの変更**: スクリプト内のプロンプト部分でカテゴリ定義を編集可能。

## トラブルシューティング

### 音声が読み上げられない場合
1. **jqがインストールされているか確認**: `which jq`
2. **パスの確認**: `gemini` コマンドが `/opt/homebrew/bin/gemini` にあるか。
3. **ボリュームの確認**: macOSのシステムボリュームが消音になっていないか。
4. **手動テスト**: `echo "テスト" | say -v "Kyoko" -r 219` を実行して声が出るか。

## 設計思想

バイブコーディングや大規模なリファクタリング作業において、AIの応答を「読む」作業は認知負荷が高くなります。
このプロジェクトは、以下の3点を目的としています：
1. **「ながら」作業の実現**: 画面を注視しなくても作業の進捗を把握できる。
2. **優先順位の自動化**: ツール実行の承認が必要な場合、不要な説明を飛ばして即座に判断を下せる。
3. **情報の凝縮**: 長文の回答をカテゴリと要約に絞ることで、本質を素早く理解する。